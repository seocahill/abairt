version: '3.8'

services:
  web:
    image: caddy:alpine
    ports:
      - "80:80"
      - "443:443"
    configs:
      - source: caddyfile_v7
        target: /etc/caddy/Caddyfile
    volumes:
      - caddy_data:/data
      - caddy_config:/config
      # - assets:/var/www/site/current/public

  rails:
    image: registry.gitlab.com/abairt/web-application:65dfd284e9ed8cfa6001999dab55a75258a1b7ed
    deploy:
      mode: replicated
      replicas: 1
    environment:
      REDIS_URL: redis://redis:6379
      SELENIUM_URL: http://chrome:4444/wd/hub
      RAILS_SERVE_STATIC_FILES: "true"
      RAILS_LOG_TO_STDOUT: "true"
      BUNDLE_PATH: "/usr/local/bundle"
      BUNDLE_WITHOUT: "development:test"
    secrets:
      - source: master_key
        target: /rails/config/master.key
    volumes:
      - db:/rails/db
      # - assets:/rails/public
    command:
      - /bin/bash
      - -c
      - |
        bin/rails db:create db:migrate
        bin/rails s -p 3000 -b 0.0.0.0

  litestream:
    image: litestream/litestream
    deploy:
      replicas: 1
    secrets:
      - source: litestream_v5
        target: /etc/litestream.yml
    volumes:
      - db:/data
    entrypoint:
      - /bin/sh
      - -c
      - |
        litestream restore -if-replica-exists -v /data/production.sqlite3
        # Fix permissions - ensure Rails user can access
        chown -R 1000:1000 /data
        chmod -R 755 /data

        # Wait a moment to ensure file operations complete
        sleep 2
        # start replication
        litestream replicate

  redis:
    image: redis:alpine

  chrome:
    image: selenium/standalone-chrome:latest
    shm_size: 2gb
    deploy:
      mode: replicated
      replicas: 1
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 1G
    environment:
      - SE_NODE_MAX_SESSIONS=5
      - SE_NODE_SESSION_TIMEOUT=300

  # pg_vector:
  #   image: ankane/pgvector
  #   volumes:
  #     - vector_db:/var/lib/postgresql/data
  #   environment:
  #     - POSTGRES_USER=
  #     - POSTGRES_PASSWORD=

volumes:
  db:
  vector_db:
  caddy_data:
  caddy_config:
  # assets:

configs:
  caddyfile_v7:
    file: ./Caddyfile

secrets:
  litestream_v5:
    file: ./litestream.yml
  master_key:
    file: ./config/master.key