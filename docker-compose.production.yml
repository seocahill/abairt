version: '3.8'

services:
  web:
    image: caddy:alpine
    ports:
      - "80:80"
      - "443:443"
    configs:
      - source: caddyfile_v7
        target: /etc/caddy/Caddyfile
    volumes:
      - caddy_data:/data
      - caddy_config:/config
      # - assets:/var/www/site/current/public

  rails:
    image: registry.gitlab.com/abairt/web-application:342a03dcc964215288e9c8ab76024acea8425dee
    deploy:
      mode: replicated
      replicas: 1
    environment:
      REDIS_URL: redis://redis:6379
      SELENIUM_URL: http://chrome:4444/wd/hub
      RAILS_SERVE_STATIC_FILES: "true"
      RAILS_LOG_TO_STDOUT: "true"
      BUNDLE_PATH: "/usr/local/bundle"
      BUNDLE_WITHOUT: "development:test"
      SELENIUM_HEADFUL: "true"
    secrets:
      - source: master_key
        target: /rails/config/master.key
    volumes:
      - db:/rails/db
      # - assets:/rails/public
    command:
      - /bin/bash
      - -c
      - |
        bin/rails db:create db:migrate
        bin/rails s -p 3000 -b 0.0.0.0

  litestream:
    image: litestream/litestream
    deploy:
      replicas: 1
    secrets:
      - source: litestream_v5
        target: /etc/litestream.yml
    volumes:
      - db:/data
    entrypoint:
      - /bin/sh
      - -c
      - |
        litestream restore -if-replica-exists -v /data/production.sqlite3
        # Fix permissions - ensure Rails user can access
        chown -R 1000:1000 /data
        chmod -R 755 /data

        # Wait a moment to ensure file operations complete
        sleep 2
        # start replication
        litestream replicate

  redis:
    image: redis:alpine

  chrome:
    image: selenium/standalone-chrome:latest
    deploy:
      mode: replicated
      replicas: 1
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 1G
      placement:
        constraints:
          - node.role == manager
    ports:
      - "7900:7900"  # noVNC web interface for visual debugging
      - "5900:5900"  # VNC port (for VNC clients)
    tmpfs:
      - /dev/shm:rw,noexec,nosuid,size=2g
    environment:
      - SE_NODE_MAX_SESSIONS=5
      - SE_NODE_SESSION_TIMEOUT=300
      - SE_VNC_NO_PASSWORD=1  # Disable VNC password for easier access


volumes:
  db:
  vector_db:
  caddy_data:
  caddy_config:
  # assets:

configs:
  caddyfile_v7:
    file: ./Caddyfile

secrets:
  litestream_v5:
    file: ./litestream.yml
  master_key:
    file: ./config/master.key