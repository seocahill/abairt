<div class="container mx-auto px-4 py-8">
  <h1 class="text-2xl font-bold mb-6">Manage Speakers for <%= link_to @voice_recording.title, voice_recording_path(@voice_recording), class: "text-blue-500 hover:text-blue-700" %></h1>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
    <!-- Temporary Speakers List -->
    <div class="bg-white p-6 rounded-lg shadow">
      <h2 class="text-xl font-semibold mb-4">Temporary Speakers</h2>
      <div class="space-y-4">
        <% @temp_speakers.each do |speaker| %>
          <div class="border p-4 rounded">
            <h3 class="font-medium"><%= speaker.name %></h3>
            <p class="text-sm text-gray-600">
              <% entries = speaker.spoken_dictionary_entries.where(voice_recording: @voice_recording) %>
              <%= pluralize(entries.count, 'entry') %>
            </p>

            <% if sample_entry = entries.with_attached_media.where.not(word_or_phrase: [nil, ""]).first %>
              <div class="my-4 p-3 bg-gray-50 rounded">
                <p class="text-sm text-gray-700"><%= sample_entry.word_or_phrase %></p>
                <% if sample_entry.media.attached? %>
                  <audio controls class="mt-2 w-full">
                    <source src="<%= rails_blob_path(sample_entry.media) %>" type="audio/mpeg">
                    Your browser does not support the audio element.
                  </audio>
                <% end %>
              </div>
            <% end %>

            <%= form_tag voice_recording_speaker_path(@voice_recording, speaker), method: :patch, class: "mt-4" do %>
              <div class="space-y-4">
                <%= select_tag :speaker_id,
                    options_from_collection_for_select(@speakers, :id, :name),
                    prompt: "Select existing speaker",
                    class: "w-full p-2 border rounded" %>

                <%= submit_tag "Update Speaker", class: "bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600" %>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Create New Speaker Form -->
    <div class="bg-white p-6 rounded-lg shadow temp-speaker-entry" data-controller="map">
      <h2 class="text-xl font-semibold mb-4">Create New Speaker</h2>
      <%= form_with(model: @new_speaker, local: true, class: "space-y-4") do |f| %>
        <div>
          <%= f.label :name, class: "block text-sm font-medium text-gray-700" %>
          <%= f.text_field :name, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm" %>
        </div>

        <div>
          <%= f.label :dialect, class: "block text-sm font-medium text-gray-700" %>
          <%= f.select :dialect, User.dialects.keys.map { |d| [d.humanize, d] }, {}, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm" %>
        </div>

        <div>
          <%= f.label :ability, class: "block text-sm font-medium text-gray-700" %>
          <%= f.select :ability, User.abilities.keys.map { |a| [a.humanize, a] }, {}, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm" %>
        </div>

        <div>
          <%= f.label :voice, "Gender", class: "block text-sm font-medium text-gray-700" %>
          <%= f.select :voice, User.voices.keys.map { |v| [v.humanize, v] }, {}, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm" %>
        </div>

        <div>
          <%= f.label :address, "Location", class: "block text-sm font-medium text-gray-700" %>
          <div class="flex items-center">
            <%= f.text_field :address, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm" %>
            <button type="button" class="ml-2" data-action="click->map#openModal">
              <svg class="w-5 h-5 text-blue-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
              </svg>
            </button>
          </div>
          <%= f.hidden_field :lat_lang, id: "user-lat-lang" %>
          <%= f.hidden_field :email, value: "#{SecureRandom.hex(32)}@abairt.com" %>
          <%= f.hidden_field :role, value: "speaker" %>
        </div>

        <div>
          <%= f.label :replace_speaker_id, "Replace Temporary Speaker", class: "block text-sm font-medium text-gray-700" %>
          <%= f.select :replace_speaker_id,
              @temp_speakers.map { |s| ["#{s.name} (#{pluralize(DictionaryEntry.where(voice_recording: @voice_recording, speaker_id: s.id).count, 'entry')})", s.id] },
              { include_blank: "Select a temporary speaker to replace" },
              class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm" %>
        </div>

        <%= f.hidden_field :role, value: :speaker %>
        <%= f.submit "Create Speaker", class: "w-full bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600" %>
      <% end %>

      <!-- Map Modal -->
      <div id="mapModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden" style="z-index: 999;" data-map-target="modal">
        <div class="relative top-20 mx-auto p-5 border w-3/4 shadow-lg rounded-md bg-white">
          <div class="flex justify-between items-center">
            <h3 class="text-lg font-medium text-gray-900">Select Location</h3>
            <button class="text-gray-500 hover:text-gray-700" data-action="click->map#closeModal">
              <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
          <div id="map" class="h-[600px] md:min-h-[50%] lg:min-h-[75%] mt-4" data-map-target="modalContainer"></div>
          <div class="mt-4 flex justify-end">
            <button type="button" class="bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600"
                    data-action="click->map#saveLocation"
                    data-map-form-only-param="true">
              Save Location
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>